<div class="admin-layout">
  <!-- Fixed Top Bar -->
  <div class="fixed-top-bar">
    <div class="top-bar-left">
      <button class="hamburger-btn" (click)="sidebar.toggleSidebar()" [class.active]="!sidebar.isCollapsed">
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
      </button>
      <h1 class="app-title">Stitch</h1>
    </div>
    <button class="notification-btn" aria-label="View notifications">
      <span class="material-icons">notifications</span>
    </button>
  </div>

  <app-shared-sidebar #sidebar [title]="'Stitch'" [navItems]="adminNavItems"></app-shared-sidebar>
  
  <div class="appointments-container">
    <div class="page-header">
      <h1>All Appointments</h1>
    </div>

    <div *ngIf="loading" class="loading">
      <div class="spinner"></div>
      <p>Loading appointments...</p>
    </div>

    <div *ngIf="!loading && appointments.length === 0" class="empty-state">
      <span class="material-icons empty-icon">event_busy</span>
      <h3>No Appointments Found</h3>
      <p>There are no appointments to display.</p>
    </div>

    <div *ngIf="!loading && appointments.length > 0" class="appointments-grid">
      <div *ngFor="let appointment of appointments" class="appointment-card">
        <div class="card-header">
          <div class="status-badge" [style.background-color]="getStatusColor(appointment.status)">
            {{ getStatusLabel(appointment.status) }}
          </div>
        </div>

        <div class="card-body">
          <div class="customer-name">
            <span class="material-icons">person</span>
            <span>{{ appointment.customerName }}</span>
          </div>

          <div class="detail-item">
            <span class="material-icons">phone</span>
            <span>{{ appointment.phoneNumber }}</span>
          </div>

          <div class="detail-item">
            <span class="material-icons">person_outline</span>
            <span>Age: {{ appointment.age }}</span>
          </div>

          <div class="detail-item">
            <span class="material-icons">event</span>
            <span>{{ appointment.deadline | date: 'medium' }}</span>
          </div>

          <div *ngIf="appointment.notes" class="notes-section">
            <div class="notes-content">
              <span class="label">Notes:</span>
              <p>{{ appointment.notes }}</p>
            </div>
          </div>

          <div *ngIf="appointment.declineReason" class="decline-reason">
            <span class="material-icons">info</span>
            <div class="decline-content">
              <span class="label">Decline Reason:</span>
              <p>{{ appointment.declineReason }}</p>
            </div>
          </div>
        </div>

        <div class="card-footer">
          <button 
            *ngIf="hasImages(appointment)" 
            class="btn-view-images" 
            (click)="viewImage(appointment)">
            <span class="material-icons">photo_library</span>
            View Images ({{ getImageCount(appointment.inspoImageUrl || '') }})
          </button>
          <span *ngIf="!hasImages(appointment)" class="no-images">No inspiration pictures</span>
          
          <!-- Measurements management -->
          <div *ngIf="appointment.status !== 'DECLINED'" class="measurements-actions">
            <button 
              *ngIf="!appointment.measurementsFileName" 
              class="btn-upload-measurements" 
              (click)="openMeasurementsUploadModal(appointment)">
              <span class="material-icons">straighten</span>
              Upload Measurements
            </button>
            
            <div *ngIf="appointment.measurementsFileName" class="measurements-buttons">
              <button class="btn-view-measurements" (click)="viewMeasurements(appointment)">
                <span class="material-icons">visibility</span>
                View Measurements
              </button>
              <button class="btn-delete-measurements" (click)="deleteMeasurements(appointment)">
                <span class="material-icons">delete</span>
              </button>
            </div>
          </div>

          <!-- Bill management for completed appointments -->
          <div *ngIf="appointment.status === 'COMPLETED'" class="bill-actions">
            <button 
              *ngIf="!appointment.billFileName" 
              class="btn-upload-bill" 
              (click)="openBillUploadModal(appointment)">
              <span class="material-icons">upload_file</span>
              Upload Bill
            </button>
            
            <div *ngIf="appointment.billFileName" class="bill-buttons">
              <button class="btn-view-bill" (click)="viewBill(appointment)">
                <span class="material-icons">visibility</span>
                View Bill
              </button>
              <button class="btn-delete-bill" (click)="deleteBill(appointment)">
                <span class="material-icons">delete</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Image Modal -->
<div *ngIf="showImageModal" class="image-modal-overlay" (click)="closeImageModal()">
  <div class="image-modal-content" (click)="$event.stopPropagation()">
    <button class="modal-close-btn" (click)="closeImageModal()">
      <span class="material-icons">close</span>
    </button>
    
    <img [src]="modalImageUrl" alt="Inspiration image" class="modal-image">
    
    <div class="image-navigation" *ngIf="totalImages > 1">
      <button 
        class="nav-btn prev-btn" 
        (click)="previousImage()" 
        [disabled]="currentImageIndex === 0">
        <span class="material-icons">chevron_left</span>
      </button>
      
      <span class="image-counter">{{ currentImageIndex + 1 }} / {{ totalImages }}</span>
      
      <button 
        class="nav-btn next-btn" 
        (click)="nextImage()" 
        [disabled]="currentImageIndex === totalImages - 1">
        <span class="material-icons">chevron_right</span>
      </button>
    </div>
  </div>
</div>

<!-- Measurements Upload Modal -->
<div *ngIf="showMeasurementsUploadModal" class="modal-overlay" (click)="closeMeasurementsUploadModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Upload Measurements</h2>
      <button class="modal-close-btn" (click)="closeMeasurementsUploadModal()">
        <span class="material-icons">close</span>
      </button>
    </div>

    <div class="modal-body">
      <p class="modal-subtitle">Customer: {{ currentMeasurementsAppointment?.customerName }}</p>
      
      <div class="file-upload-area">
        <input 
          type="file" 
          #measurementsFileInput 
          accept="application/pdf,image/jpeg,image/jpg,image/png" 
          (change)="onMeasurementsFileSelected($event)"
          [disabled]="uploadingMeasurements"
          aria-label="Select measurements file">
        
        <input 
          type="file" 
          #measurementsCameraInput 
          accept="image/*" 
          capture="environment"
          (change)="onMeasurementsFileSelected($event)"
          [disabled]="uploadingMeasurements"
          aria-label="Take photo of measurements">
        
        <div *ngIf="!selectedMeasurementsFile" class="upload-options">
          <button type="button" class="upload-option-btn" (click)="measurementsFileInput.click()" [disabled]="uploadingMeasurements">
            <span class="material-icons">upload_file</span>
            <span>Select File</span>
          </button>
          <button type="button" class="upload-option-btn" (click)="measurementsCameraInput.click()" [disabled]="uploadingMeasurements">
            <span class="material-icons">photo_camera</span>
            <span>Take Photo</span>
          </button>
          <p class="hint">PDF, JPG, PNG up to 10MB</p>
        </div>

        <div *ngIf="selectedMeasurementsFile" class="file-selected">
          <span class="material-icons">description</span>
          <span class="file-name">{{ selectedMeasurementsFile.name }}</span>
          <button type="button" class="btn-remove-file" (click)="selectedMeasurementsFile = null; measurementsFileInput.value = ''" [disabled]="uploadingMeasurements">
            <span class="material-icons">close</span>
          </button>
        </div>
      </div>

      <div *ngIf="measurementsErrorMessage" class="error-message">
        <span class="material-icons">error</span>
        {{ measurementsErrorMessage }}
      </div>

      <div class="modal-actions">
        <button class="btn-secondary" (click)="closeMeasurementsUploadModal()" [disabled]="uploadingMeasurements">
          Cancel
        </button>
        <button class="btn-primary" (click)="uploadMeasurements()" [disabled]="!selectedMeasurementsFile || uploadingMeasurements">
          <span *ngIf="!uploadingMeasurements">Upload</span>
          <span *ngIf="uploadingMeasurements">Uploading...</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Bill Upload Modal -->
<div *ngIf="showBillUploadModal" class="modal-overlay" (click)="closeBillUploadModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Upload Bill</h2>
      <button class="modal-close-btn" (click)="closeBillUploadModal()">
        <span class="material-icons">close</span>
      </button>
    </div>

    <div class="modal-body">
      <p class="modal-subtitle">Customer: {{ currentBillAppointment?.customerName }}</p>
      
      <div class="file-upload-area">
        <input 
          type="file" 
          #billFileInput 
          accept="application/pdf,image/jpeg,image/jpg,image/png" 
          (change)="onBillFileSelected($event)"
          [disabled]="uploadingBill"
          aria-label="Select bill file">
        
        <input 
          type="file" 
          #billCameraInput 
          accept="image/*" 
          capture="environment"
          (change)="onBillFileSelected($event)"
          [disabled]="uploadingBill"
          aria-label="Take photo of bill">
        
        <div *ngIf="!selectedBillFile" class="upload-options">
          <button type="button" class="upload-option-btn" (click)="billFileInput.click()" [disabled]="uploadingBill">
            <span class="material-icons">upload_file</span>
            <span>Select File</span>
          </button>
          <button type="button" class="upload-option-btn" (click)="billCameraInput.click()" [disabled]="uploadingBill">
            <span class="material-icons">photo_camera</span>
            <span>Take Photo</span>
          </button>
          <p class="hint">PDF, JPG, PNG up to 10MB</p>
        </div>

        <div *ngIf="selectedBillFile" class="file-selected">
          <span class="material-icons">description</span>
          <span class="file-name">{{ selectedBillFile.name }}</span>
          <button type="button" class="btn-remove-file" (click)="selectedBillFile = null; billFileInput.value = ''" [disabled]="uploadingBill">
            <span class="material-icons">close</span>
          </button>
        </div>
      </div>

      <div *ngIf="billErrorMessage" class="error-message">
        <span class="material-icons">error</span>
        {{ billErrorMessage }}
      </div>

      <div class="modal-actions">
        <button class="btn-secondary" (click)="closeBillUploadModal()" [disabled]="uploadingBill">
          Cancel
        </button>
        <button class="btn-primary" (click)="uploadBill()" [disabled]="!selectedBillFile || uploadingBill">
          <span *ngIf="!uploadingBill">Upload</span>
          <span *ngIf="uploadingBill">Uploading...</span>
        </button>
      </div>
    </div>
  </div>
</div>

