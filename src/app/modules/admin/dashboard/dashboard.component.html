<div class="admin-layout">
  <!-- Sidebar Navigation -->
  <app-shared-sidebar [title]="'Stitch'" [navItems]="adminNavItems"></app-shared-sidebar>

  <!-- Main Content -->
  <div class="dashboard-container">
    <div class="top-bar">
      <div class="dashboard-header">
        <h1>Admin Dashboard</h1>
      </div>
      <div class="header-actions">
        <button class="notification-btn" aria-label="View messages">
          <span class="material-icons">mail</span>
        </button>
        <button class="notification-btn" aria-label="View notifications">
          <span class="material-icons">notifications</span>
          <span class="badge" *ngIf="getPendingCount() > 0">{{ getPendingCount() }}</span>
        </button>
      </div>
    </div>

    <!-- Quick Statistics -->
    <app-stats-grid 
      *ngIf="!loading"
      [pendingCount]="getPendingCount()"
      [approvedCount]="getApprovedCount()"
      [completedCount]="getCompletedCount()"
      [totalCount]="appointments.length">
    </app-stats-grid>

    <!-- Upcoming Deadlines -->
    <app-upcoming-deadlines 
      *ngIf="!loading"
      [deadlines]="getUpcomingDeadlines()">
    </app-upcoming-deadlines>

    <!-- Appointments List -->
    <app-appointments-list
      [appointments]="filteredAppointments"
      [selectedStatus]="selectedStatus"
      [loading]="loading"
      (statusChange)="onStatusChange($event)"
      (approve)="approveAppointment($event)"
      (decline)="declineAppointment($event)"
      (updateStatus)="updateAppointmentStatus($event)">
    </app-appointments-list>

    <!-- Completed Appointments -->
    <div class="section" *ngIf="!loading && getCompletedAppointments().length > 0">
      <h2>Completed Appointments</h2>
      <div class="card-grid">
        <div class="appointment-card-small completed" *ngFor="let appointment of getCompletedAppointments()">
          <div class="card-icon">
            <span class="material-icons">check_circle</span>
          </div>
          <div class="card-content">
            <h4>{{ appointment.customerName }}</h4>
            <p class="phone">{{ appointment.phoneNumber }}</p>
            <p class="age">Age: {{ appointment.age }}</p>
            <p class="deadline">{{ appointment.deadline | date:'MMM dd, yyyy' }}</p>
            <div class="card-actions">
              <button *ngIf="appointment.inspoImageUrl" (click)="viewImage(appointment)" class="btn-view-card" title="View image">
                <span class="material-icons">visibility</span>
                View Inspiration Picture
              </button>
              <span *ngIf="!appointment.inspoImageUrl" class="no-image">No inspiration pictures</span>
            </div>
            <div class="measurements-actions-card" *ngIf="appointment.measurementsFileName">
              <div class="measurements-buttons-card">
                <button class="btn-view-measurements-card" (click)="viewMeasurements(appointment)" title="View measurements">
                  <span class="material-icons">straighten</span>
                  View Measurements
                </button>
                <button class="btn-delete-measurements-card" (click)="deleteMeasurements(appointment)" title="Delete measurements">
                  <span class="material-icons">delete</span>
                </button>
              </div>
            </div>
            <div class="bill-actions-card">
              <button 
                *ngIf="!appointment.billFileName" 
                class="btn-upload-bill-card" 
                (click)="openBillUploadModal(appointment)"
                title="Upload bill">
                <span class="material-icons">upload_file</span>
                Upload Bill
              </button>
              <div *ngIf="appointment.billFileName" class="bill-buttons-card">
                <button class="btn-view-bill-card" (click)="viewBill(appointment)" title="View bill">
                  <span class="material-icons">visibility</span>
                  View Bill
                </button>
                <button class="btn-delete-bill-card" (click)="deleteBill(appointment)" title="Delete bill">
                  <span class="material-icons">delete</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Declined Appointments -->
    <div class="section declined-section" *ngIf="!loading && getDeclinedAppointments().length > 0">
      <h2>Declined Appointments</h2>
      <div class="card-grid">
        <div class="appointment-card-small declined" *ngFor="let appointment of getDeclinedAppointments()">
          <div class="card-icon">
            <span class="material-icons">cancel</span>
          </div>
          <div class="card-content">
            <h4>{{ appointment.customerName }}</h4>
            <p class="phone">{{ appointment.phoneNumber }}</p>
            <p class="deadline">{{ appointment.deadline | date:'MMM dd, yyyy' }}</p>
            <p class="reason" *ngIf="appointment.notes">{{ appointment.notes }}</p>
            <div class="card-actions">
              <button *ngIf="appointment.inspoImageUrl" (click)="viewImage(appointment)" class="btn-view-card" title="View image">
                <span class="material-icons">visibility</span>
                View
              </button>
              <span *ngIf="!appointment.inspoImageUrl" class="no-image">No inspiration pictures</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Image Modal -->
    <div class="image-modal-overlay" *ngIf="showImageModal" (click)="closeImageModal()">
      <div class="image-modal-content" (click)="$event.stopPropagation()">
        <button class="modal-close-btn" (click)="closeImageModal()" aria-label="Close">
          <span class="material-icons">close</span>
        </button>
        
        <button *ngIf="totalImages > 1 && currentImageIndex > 0" class="modal-nav-btn modal-nav-prev" (click)="previousImage()" aria-label="Previous image">
          <span class="material-icons">chevron_left</span>
        </button>
        
        <img [src]="modalImageUrl" alt="Appointment inspiration image" class="modal-image">
        
        <button *ngIf="totalImages > 1 && currentImageIndex < totalImages - 1" class="modal-nav-btn modal-nav-next" (click)="nextImage()" aria-label="Next image">
          <span class="material-icons">chevron_right</span>
        </button>
        
        <div *ngIf="totalImages > 1" class="image-counter">
          {{ currentImageIndex + 1 }} / {{ totalImages }}
        </div>
      </div>
    </div>

    <!-- Bill Upload Modal -->
    <div *ngIf="showBillUploadModal" class="modal-overlay" (click)="closeBillUploadModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <button class="modal-close" (click)="closeBillUploadModal()">Ã—</button>
        <h2>Upload Bill</h2>
        <div class="modal-body">
          <div class="file-upload-area">
            <input 
              type="file" 
              #billFileInput 
              (change)="onBillFileSelected($event)" 
              accept=".pdf,.jpg,.jpeg,.png"
              class="hidden-file-input"
              aria-label="Select bill file">
            <input 
              type="file" 
              #billCameraInput 
              (change)="onBillFileSelected($event)" 
              accept="image/*"
              capture="environment"
              class="hidden-file-input"
              aria-label="Take photo of bill">
            <div *ngIf="!selectedBillFile" class="upload-options">
              <button type="button" class="upload-option-btn" (click)="billFileInput.click()" [disabled]="uploadingBill">
                <span class="material-icons">upload_file</span>
                <span>Select File</span>
              </button>
              <button type="button" class="upload-option-btn" (click)="billCameraInput.click()" [disabled]="uploadingBill">
                <span class="material-icons">photo_camera</span>
                <span>Take Photo</span>
              </button>
              <p class="file-hint">Supported: PDF, JPG, PNG (Max 10MB)</p>
            </div>
            <div *ngIf="selectedBillFile" class="file-selected">
              <span class="material-icons">description</span>
              <span>{{ selectedBillFile.name }}</span>
            </div>
            <p *ngIf="billErrorMessage" class="error-message">{{ billErrorMessage }}</p>
          </div>
          <div class="modal-actions">
            <button class="btn-cancel" (click)="closeBillUploadModal()" [disabled]="uploadingBill">Cancel</button>
            <button 
              class="btn-upload" 
              (click)="uploadBill()" 
              [disabled]="!selectedBillFile || uploadingBill">
              {{ uploadingBill ? 'Uploading...' : 'Upload' }}
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
